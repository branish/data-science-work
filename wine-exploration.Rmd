---
title: "wine-exploration"
author: "branish"
date: "8/4/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#library(readr)
library(tidyverse)
library(ggrepel)

library("tm")
library("SnowballC")
library("wordcloud")
library("RColorBrewer")
library("Matrix")
library("utf8")
library("jsonlite")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r load-csv}
filename <- "./data/CellarTrackerWithIDs.csv"

## Load the data
df_cellartracker <-
  read_csv(filename)

# df_cellartracker <-
#   df_cellartracker %>%
#   separate(col = name, into = c('winename', 'loc'), sep = ', ', extra = 'merge') %>%
#   separate(col = loc, into = c('region', 'country'), sep = ', ', fill = 'left') %>%
#   mutate(
#     rating_100 = str_extract(rating_100, '^(\\d+)'),
#     price = as.integer(str_remove_all(price, '[\\$,]')),
#     searchrank = as.integer(str_remove_all(searchrank, '\\D'))
#   )
# df_cellartracker %>%
#   write_csv(path = './data/cellrtracker_top500_by_rating_cleaner.csv')

```

``` {r plot-some-stuff}
df_cellartracker %>%
  ggplot(aes(x = price, y = searchrank)) +
  geom_point(aes(color = country)) +
  scale_y_log10() +
  scale_x_log10()

df_cellartracker %>%
  ggplot(aes(x = factor(rating_100), y = -searchrank)) +
  geom_boxplot(aes(group = country)) +
  coord_flip()
  #scale_y_log10() +
  #facet_wrap( ~ country)


```





```{r load}
filename <- "./data/winemag-data-130k-v2.csv"
## Load the data
df_wine <- read_csv(filename)

df_wine <-
  df_wine %>%
  mutate(vintage = parse_number(title)) %>%
  filter(vintage > 1900 & vintage < 2020)
```
## Ben's plots ##

```{r 1}
df_wine %>% 
  ggplot()+
  geom_point(aes(x = price, y = points))
```

```{r 2}
df_wine %>% 
  ggplot()+
  geom_histogram(aes( x = points, binwidth = 5, edge =90))+
  ggtitle("Histogram of Points")
df_wine %>% 
  ggplot()+
  geom_density(aes( x = price))+
  ggtitle("Density of Price")+
  scale_x_log10()
```
```{r}
df_wine %>% 
  filter(country == "Portugal" | country == "US" | country == "France" | country == "Italy" | country == "Austria") %>% 
  ggplot()+
  geom_density(aes( x = price, color = country))+
    ggtitle("Density of Price")+
  scale_x_log10()
  
```

```{r 3}
summary(df_wine)
glimpse(df_wine)
```
```{r 4}
df_wineries <- df_wine %>% 
group_by(winery) %>% 
   summarize(avgprice = median(price, na.rm = TRUE), "avgpoints" = mean(points, na.rm = TRUE), "n" = n(), stdevpoints = sd(points, na.rm = TRUE) ) %>% 
  filter(n>20) %>% 
  arrange(desc(n))
  
df_wineries %>% 
  filter(n>115| (n>25 & avgpoints > 93) | (n > 40 & avgprice < 10)) %>%
  ggplot(aes(x = avgpoints,y = avgprice))+
  geom_point(data = df_wineries, alpha = .2)+
  geom_point( mapping = aes(size = n, color = stdevpoints), alpha = .9)+
    scale_color_gradient(low = "green", high = "black")+
  scale_y_log10()+
   scale_size(range = c(1,8), name = "Reviews")+
  geom_label_repel(aes(label = winery))+
  ggtitle("Wine Grouped By Wineries")
```
```{r 5}
df_wine %>% 
group_by(country) %>% 
  summarize(avgprice = median(price, na.rm = TRUE), "avgpoints" = mean(points, na.rm = TRUE), "n" = n()) %>% 
  filter(n>30) %>% 
  ggplot(aes(x = avgpoints,y = avgprice))+
  geom_point(aes(size = n, alpha = .5))+
  scale_size(range = c(1,24), name = "Reviews")+
  geom_label_repel(aes(label = country), size = 2)+
  ggtitle("Wine Grouped By Country")
```
```{r 6}
df_wine %>% 
group_by(variety) %>% 
  summarize("avgprice" = median(price, na.rm = TRUE), "avgpoints" = mean(points, na.rm = TRUE), "n" = n())  %>% 
  filter(n >1200) %>% 
arrange(desc(n)) %>% 
  ggplot(aes(x = avgpoints,y = avgprice))+
  geom_point(aes(size = n, alpha = .5))+
  scale_size(range = c(1,24), name = "Reviews")+
  geom_label_repel(aes(label = variety), size = 2)+
  ggtitle("Wine Grouped By Variety")
```
```{r 7}
provinces800 <- df_wine %>% 
group_by(province) %>% 
  summarize("avgprice" = median(price, na.rm = TRUE), "avgpoints" = mean(points, na.rm = TRUE), "n" = n())  %>% 
  filter(n >1000 | (avgpoints > 90 & n>60)) %>% 
arrange(desc(n))
provinces80 <- df_wine %>% 
group_by(province) %>% 
  summarize("avgprice" = mean(price, na.rm = TRUE), "avgpoints" = mean(points, na.rm = TRUE), "n" = n())  %>% 
  filter(n >60) %>% 
arrange(desc(n))
 ggplot(data = provinces80, mapping = aes(x = avgpoints,y = avgprice))+
  geom_point(aes(size = n, alpha = .5))+
  scale_size(range = c(1,24), name = "Reviews")+
  geom_label_repel(data = provinces800, mapping = aes(label = province), size = 2)+
   ggtitle("Wine Grouped By Province")
 
```


```{r 8}
df_wine %>% 
group_by(title) %>% 
  summarize("avgprice" = median(price, na.rm = TRUE), "avgpoints" = mean(points, na.rm = TRUE), "n" = n())  %>% 
  filter(n >2) %>% 
arrange(desc(n)) %>% 
   ggplot(aes(x = avgpoints,y = avgprice))+
  geom_point(aes(size = n, alpha = .5))+
  scale_size(range = c(1,4), name = "Reviews")+
  scale_y_log10()+
  geom_smooth(se = FALSE)+
  ggtitle("Wines with 3+ Reviews")
 
```

```{r}

df_winemag <- read_csv('./data/winemag-data-130k-v2.csv')
df_globalwine <- read_csv('./data/GlobalWineScoreWithIDs.csv')

#df_wine %>%
  #filter(str_detect(description, 'thyme'))



```

## Let's try a word cloud! ##
df_wine is too big for the matrix step, so I'm using a smaller slice.
Here is the word cloud for reviews of wines from Italy.

```{r}
irrelevant_words <-
  c(
    "notes", 
    "producers", "made", "wine", "delivery", 
    "many", "wines", "still", "take", "hints", "especially", "box", "sets", 
    "nose", "already", "grown", "quite", "long",
    "although", "region", "along", "palate", "also", "carries", "whiff",
    "mouthfeel", "gives", "way", "alongside", "fully", "characterized", "mouth", 
    "capture", "feels", "get", "touches", "makes", "carry", "rather", "come", "will", "recall", "offering", "glass", "offers", "opens", "opening", "finish", "drink", "note", "delivers", "shows", "touch", "starting", "starts", "giving", "create", "example", "notice", "appear", "hint", "aroma", "aromas", "one", "together", "support", "thanks", "length", "produced", "accentuate", "accentuates", "access", "accesses", "accessable", "accessible", "accept"
  )

fnMakeWordCountMatrix <-
  (function(charinput)
  {
    corp <- Corpus(VectorSource(charinput))
    print('Converting to UTF-8...')
    corp <- tm_map(corp, as_utf8)
    print('Converting some things to spaces...')
    toSpace <- content_transformer(function (x , pattern ) gsub(pattern, " ", x))
    corp <- tm_map(corp, toSpace, "[\\.,]")
    corp <- tm_map(corp, toSpace, "\\s-\\s")
    #corp <- tm_map(corp, toSpace, "\\\\u0097")
    # Convert the text to lower case
    print('Convert to lowercase...')
    corp <- tm_map(corp, content_transformer(tolower))
    # Remove numbers
    print('Remove numbers...')
    corp <- tm_map(corp, removeNumbers)
    # Remove english common stopwords
    print('Remove stopwords...')
    corp <- tm_map(corp, removeWords, stopwords("english"))
    # Remove your own stop word
    # specify your stopwords as a character vector
    corp <- tm_map(corp, removeWords, irrelevant_words) 
    # Remove punctuations
    print('Remove punctuation...')
    corp <- tm_map(corp, removePunctuation)
    # Eliminate extra white spaces
    print('Strip extra whitespace...')
    corp <- tm_map(corp, stripWhitespace)
    # Text stemming
    #corp <- tm_map(corp, stemDocument) # this yielded weird results
    print('Text cleanup is done! Returning matrix.')
    
    dtm <- TermDocumentMatrix(corp)
    m <- as.matrix(dtm)

    # Return m
    m
  })

fnDrawWordCloud <-
  (function(m, title)
  {
    v <- sort(rowSums(m), decreasing = TRUE)
    d <- data.frame(word = names(v), freq = v)
    head(d, 10)
    
    set.seed(1234)
    
    layout(matrix(c(1, 2), nrow = 2), heights = c(1, 4))
    par(mar = rep(0, 4))
    plot.new()
    text(x = 0.5, y = 0.5, title)
    wordcloud(
      main = 'Title',
      words = d$word,
      freq = d$freq,
      min.freq = 1,
      max.words = 200,
      random.order = FALSE,
      #rot.per = 0.35, 
      rot.per = 0,
      fixed.asp = FALSE,
      colors = brewer.pal(8, "Dark2"))
  })

# # Italy
# m_italy <- df_wine %>% filter(country == 'Italy') %>% fnMakeWordCountMatrix()
# 
# # France
# m_france <- df_wine %>% filter(country == 'France') %>% fnMakeWordCountMatrix()
# 
# library(dplyr)
# glimpse(m_italy)
# glimpse(m_france)
# glimpse(df_wine %>% filter(country == 'Italy'))
# # US
# m_us <- df_wine %>% filter(country == 'US') %>% sample_n(10000) %>% fnMakeWordCountMatrix()
# glimpse(m_us)
# m_us
# 
# m_italy %>% fnDrawWordCloud(title = 'Wines from Italy')
# m_france %>% fnDrawWordCloud(title = 'Wines from France')
# m_us %>% fnDrawWordCloud(title = 'Wines from US')


```

I'd like to slice things in different ways. Lee suggests grape variety.
```{r}

varieties <-
  df_wine %>%
  group_by(variety) %>%
  summarize(n = n()) %>%
  arrange(desc(n))
varieties$variety <-
  factor(x = varieties$variety, levels = varieties$variety[order(varieties$n)])

varieties %>%
  filter(rank(desc(n)) <= 30) %>%
  ggplot(aes(x = variety, y = n)) +
  geom_col(stat = 'identity') +
  coord_flip() +
  ggtitle('30 most reviewed grape varieties')
```
What are the most common words in wine reviews for the top 3 reviewed varieties?
(Bar charts would be more useful, but word clouds are more fun.)
```{r}
m_pinotnoir <- df_wine %>% filter(variety == 'Pinot Noir') %>% fnMakeWordCountMatrix()
m_chard <- df_wine %>% filter(variety == 'Chardonnay') %>% fnMakeWordCountMatrix()
m_cabsauv <- df_wine %>% filter(variety == 'Cabernet Sauvignon') %>% fnMakeWordCountMatrix()

m_pinotnoir %>% fnDrawWordCloud(title = 'Pinot Noir')
m_chard %>% fnDrawWordCloud(title = 'Chardonnay')
m_cabsauv %>% fnDrawWordCloud(title = 'Cabernet Sauvignon')


df_wine %>% filter(region_1 == "Sauternes") %>%
  ggplot(aes(x = vintage, group = vintage, y = points)) +
  geom_boxplot() +
  ggtitle('Point distribution per year for Sauternes region')

# These group sample sizes are too small to be effective.
m_sauternes <- df_wine %>% filter(region_1 == "Sauternes") %>% fnMakeWordCountMatrix()
m_sauternes_2005 <- df_wine %>% filter(region_1 == "Sauternes", vintage == 2005) %>% fnMakeWordCountMatrix()

m_sauternes %>% fnDrawWordCloud(title = 'Sauternes')
m_sauternes_2005 %>% fnDrawWordCloud(title = 'Sauternes 2005')
```
```{r}
df_scraper <-
  read_csv('./data/facts_about_winereviews94p.csv', na = 'n/a') %>%
  select(-vintage, -natural, -organic, -biodynamic, -buyUrl, -structureCount, -aromaIntensity, -primaryAromas, -secondaryAromas, -tertiaryAromas, -balance, -length, -finish, -complexity, -conclusion, -ageing, -quality, -body, -noseDevelopment, -noseIntensity, -colorIntensity, -color, -tertiaryFlavors, -professionalReviews, -userReviews) %>%
  distinct(`_id`, `_vintageId`, .keep_all = TRUE)

glimpse(df_scraper)
```

``` {r}

# df_scraperflavors <-
#   df_scraper %>%
#   select(`_id`, name, primaryFlavors, secondaryFlavors) %>%
#   mutate(
#     primaryFlavors = map(primaryFlavors, fromJSON),
#     secondaryFlavors = map(secondaryFlavors, fromJSON)
#   )
# 
# glimpse(df_scraperflavors)
# 
# all_primary_flavors <-
#   df_scraperflavors %>%
#   select(`_id`, primaryFlavors) %>%
#   unnest(c(primaryFlavors)) %>%
#   group_by(name) %>%
#   summarize(count = sum(count))
```

``` {r json}
# df_scraperflavors %>%
#   #slice(1:4) %>%
#   mutate(fSweaty = map(primaryFlavors, fnListHasFlavor, 'sweaty saddle')) %>%
#   unnest(fSweaty) %>%
#   filter(fSweaty) %>%
#   select(name) %>%
#   knitr::kable(caption = 'Wines characterized as "sweaty saddle"')

df_scraper_json <-
  df_scraper %>%
  mutate(
    primaryFlavors = map(primaryFlavors, fromJSON),
    secondaryFlavors = map(secondaryFlavors, fromJSON),
    grapes = map(grapes, fromJSON)
  )

glimpse(df_scraper_json)
```



``` {r grapes}
df_grapes <-
  df_scraper_json %>%
  unnest(grapes) %>%
  group_by(grapes, tannin) %>%
  summarize(winecount = n()) %>%
  mutate(is_white = is.na(tannin)) %>%
  arrange(desc(winecount)) #%>%
  #write_csv('./data/grapes.csv')

df_grapes
```


``` {r findflavor}
# Return TRUE if the requested flavorname is in the list. Helper for the nested dataframe columns.
fnListHasElement <-
  function(li, elementname)
  {
    has_element(li$name, elementname)
  }

#map((df_scraper_json %>% slice(1:4))$primaryFlavors, fnListHasFlavor, 'vanilla')
```



``` {r sweaty}
df_sweaty <-
  df_scraper_json %>%
  mutate(fSweaty = map(primaryFlavors, fnListHasElement, 'sweaty saddle')) %>%
  unnest(fSweaty) %>%
  filter(fSweaty)

df_sweaty %>%
  select(name, price) %>%
  knitr::kable(caption = 'Wines characterized as "sweaty saddle"')

  
# glimpse(all_primary_flavors)
# tibble(all_primary_flavors %>% arrange(count))

```

```
